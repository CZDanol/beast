% !TeX spellcheck = en_US

\include{header}
\include{mainpage}
\include{support}

\setlength\extrarowheight{2pt}

% Title Page
\title{NATI (Not All That Innovative) programming language}
\subtitle{Language specification/reference}
\author{Daniel ÄŒejchan}
\date{2016}


\begin{document}
\mainpage
%\renewcommand{\clearpage}{}

\chapter{Table of contents}
\makeatletter
\@starttoc{toc}
\makeatother

\chapter{Introduction}
NATI is an imperative, structured, modular programming language supporting OO and functional paradigms. Currently, only transcompilation to C++ is available. In future, a LLVM backend integration is planned.

NATI is a practical tool for practical programmers. With NATI, you can write effective and readable code quite fast. Although the language itself builds on a significant abstraction, the functionality behind it is still close to HW. If you know the language, you can pretty well determine what assembly each line of your code generates.

Basic language classification:
\begin{itemize}
	\item Imperative
	\item Classes are instances of \verb|Type| class
	\item Statically typed
\end{itemize}

\section{Why choose NATI}
\begin{itemize}
	\item \textbf{Good programming practices} NATI gently pushes you into writing your code readable and understandable.
	\item \textbf{Compile-time magic} In NATI, you can do many things much better in compile time. It has compile-time reflection, you can execute almost any function in compile time, ...
\end{itemize}

\subsection{Why choose NATI over C++}
\begin{itemize}
	\item \textbf{Modules} In NATI, you don't have to write separate header and source files and struggle with keeping them synchronized.
\end{itemize}


\chapter{Lexical}
In a normal code, NATI accepts only standard ASCII characters. Non-ascii characters are allowed only in comments and string literals.

\begin{grammar}
	\tokenDef{Whitespace} \verb|[\n\t ]+|
\end{grammar}

\section{Identifiers}
\begin{grammar}
	\tokenDef{Identifier} \verb|#?[a-zA-Z_][a-zA-Z_0-9]*|
\end{grammar}
An identifier consists of any combination of lower and upper case ASCII letters, numbers and undescores, with these additional rules:
\begin{itemize}
	\item An identifier cannot begin with a number.
	\item An identifier can begin with the hasthag (\verb|#|) character. These identifiers are used in various language constructs and can have restrictions of where and how they can be used in declarations.
\end{itemize}

\section{Keywords} \label{keywords}
\begin{code}
alias, auto, break, case, class, continue, else, enum, except, finally, for, if, import, in, is, module, return, switch, this, throw, try, while
\end{code}

\subsection{Reserved words}
\begin{code}
asm, auto, blueprint, debug, decorator, delegate, do, foreach, function, generic, goto, loop, scope, singleton, template, this, with, yield
\end{code}

\section{Literals}
\begin{grammar}
	\grDef{Literal} \gr{UnitLiteral} [ \token{Identifier} ] \\
	\grDef{UnitLiteral} \gr{StringLiteral} \\
		\grAltLn \gr{IntLiteral} \\
		\grAltLn \gr{BinLiteral} \\
		\grAltLn \gr{OctLiteral} \\
		\grAltLn \gr{HexLiteral} \\
		\grAltLn \gr{FloatLiteral} \\
\end{grammar}

\subsection{Boolean 'literals'}
NATI does provide \inlineCode{true} and \inlineCode{false}, however those are not keywords or literals, but just \decoratorRef{ctime} variables defined from the runtime library. That means that they can be redefined.

\subsection{The 'null' 'literal'}
The \inlineCode{null} is a \typeRef{Type} which is statically implicitly castable to pointer or reference of any type. It is not a keyword; it is defined in runtime library and thus can be redefined.

\subsection{Integer literals}
\begin{grammar}
	\tokenDef{IntLiteral} \verb|-?[0-9]+| \\
	\tokenDef{BinLiteral} \verb|-?0b[01]+| \\
	\tokenDef{OctLiteral} \verb|-?0o[0-7]+| \\
	\tokenDef{HexLiteral} \verb|-?0x[0-9a-fA-F]+|
\end{grammar}

\paragraph{Data type} Type of a literal is always the smallest signed type possible. If the number doesn't fit in the signed variant but fits in the unsigned variant with the same size, the unsigned variant is used (doesn't apply to negative literals). If the required bit count exceeds 128, a \typeRef{BigInt} type is used.

\begin{code}
10 // Int8
128 // UInt8
-10 // Int8
-150 // Int16
60000 // Int16
0xaa // UInt8
0xa01 // UInt16
\end{code}

\subsection{Float literals}
\begin{grammar}
	\tokenDef{FloatLiteral} \verb|-?[0-9]*\.[0-9]+([eE][+-]?[0-9]+)?|
\end{grammar}

\paragraph{Data type} Float literal is always of type \typeRef{Float64}. It is recommended to use the \verb|f| for casting to \typeRef{Float32} (alternatively, you can use the explicit cast).

\subsection{User-defined literals} \label{userDefinedLiterals}
NATI supports a syntactical construct that allows users to define their own literals. The user defined literal is then represented by a standard NATI literal followed by an identifier.

An appropriate function with prototype
\begin{code}
@ctime auto #literal( String suffix, String value, Literal type );
\end{code}
is then called where the first argument is the \token{Identifier} used, the second is the literal value (stringified) and the third is the type of the literal.

\begin{code}
enum Literal {
	stringLiteral,
	intLiteral,
	binLiteral,
	octLiteral,
	hexLiteral,
	floatLiteral;
	
@public:
	enum : Set {
		number = intLiteral | floatLiteral;	
	}
}
\end{code}

\begin{code}
@ctime Float32[ String ] lengthUnits = [
	"km": 1e3, "m": 1, "dm": 1e-1, "cm": 1e-2, "mm": 1e-3
];
	
@ctime Length #literal( String suffix, String value, Literal type )
	if( type is :number && suffix in lengthUnits.keys )
{
	return Length( value.to( Float32 ) * lengthUnits[ unit ] );
}

// Here, the #literal function is called with arguments #literal( "cm", "32.5", Literal.floatLiteral )
Length len = 32.5 cm;
\end{code}

\paragraph{TODO} string literals, char literals

\section{Comments}
\begin{grammar}
	\tokenDef{LineComment} \verb|//[^\n$][\n$]| \\
	\tokenDef{Comment} \verb|/\*.*?\*/|
\end{grammar}
Additionally, \textbf{comments can be nested}.

\begin{code}
void main() {
	/* This is a comment
		/* This is a comment, too. */
		Still a comment */
	thisIsACode();
}
\end{code}

\chapter{Expressions}
\begin{grammar}
	\grDef{Expression} \gr{AssignExpr} \\
	\grDef{CommaExpression} \gr{Expression} \{ \kwd{,} \gr{Expression} \} \\
	
	\\
	
	\grDef{ParentCommaExpr} \kwd{(} [ \gr{ParentCommaExprItem} \{ \kwd{,} \gr{ParentCommaExprItem} \} ] \kwd{)} \\
	\grDef{ParentCommaExprItem} ( \gr{InexprVarDecl} | \gr{Expression} ) [ \kwd{...} ] \\
	
\end{grammar}

\section{Operators}
\begin{grammar}
	\grDef{RangeExpr} \gr{TernExpr} \\
		\grAltLn \gr{TernExpr} \kwd{..} \gr{TernExpr} \\
	
	\grDef{AssignExpr} \gr{TernExpr} \\
		\grAltLn \gr{TernExpr} \gr{AssignOpOp} \gr{TernExpr} \\
		\grAltLn \gr{TernExpr} \{ \kwd{=} \gr{TernExpr} \}+ \\
		\grAltLn \gr{TernExpr} \{ \kwd{:=} \gr{TernExpr} \}+ \\
	
	\grDef{TernExpr} \gr{LogicExpr} \\
		\grAltLn \gr{LogicExpr} \kwd{?} \gr{LogicExpr} \kwd{:} \gr{LogicExpr} \\
	
	\grDef{LogicExpr} \gr{CmpExpr} \\
		\grAltLn \gr{CmpExpr} \{ \kwd{\&\&} \gr{CmpExpr} \}+ \\
		\grAltLn \gr{CmpExpr} \{ \kwd{||} \gr{CmpExpr} \}+ \\
		
	\grDef{CmpExpr} \gr{BitExpr} \\
		\grAltLn \gr{BitExpr} ( \kwd{is} | \kwd{!is} | \kwd{in} | \kwd{!in} | \kwd{!=} ) \gr{BitExpr} \\
		\grAltLn \gr{BitExpr} \{ ( \kwd{==} | \kwd{>=} | \kwd{>} ) \gr{BitExpr} \}+ \\
		\grAltLn \gr{BitExpr} \{ ( \kwd{==} | \kwd{<=} | \kwd{<} ) \gr{BitExpr} \}+ \\
		
	\grDef{BitExpr} \gr{SumExpr} \\
		\grAltLn \gr{UnaryExpr} ( \kwd{>{}>} | \kwd{<{}<} | \kwd{>{}>{}>} | \kwd{<{}<{}<} ) \gr{UnaryExpr} \\
		\grAltLn \gr{UnaryExpr} \{ \kwd{\&} \gr{UnaryExpr} \}+ \\
		\grAltLn \gr{UnaryExpr} \{ \kwd{|} \gr{UnaryExpr} \}+ \\
		\grAltLn \gr{UnaryExpr} \{ \kwd{\^} \gr{UnaryExpr} \}+ \\
	
	\grDef{SumExpr} \gr{MultExpr} \\
		\grAltLn \gr{MultExpr} \{ ( \kwd{+} | \kwd{-} ) \gr{MultExpr} \}+ \\
	
	\grDef{MultExpr} \gr{UnaryExpr} \\
		\grAltLn \gr{UnaryExpr} \{ ( \kwd{*} | \kwd{/} ) \gr{UnaryExpr} \}+ \\
		\grAltLn \gr{UnaryExpr} \kwd{\%} \gr{UnaryExpr} \\
	
	\grDef{UnaryExpr} \gr{P1Expr} \\
		\grAltLn ( \kwd{!} | \kwd{-} | \kwd{\~} | \kwd{++} | \kwd{-{}-} ) \gr{P1Expr} \\
		\grAltLn \gr{P1Expr} ( \kwd{++} | \kwd{-{}-} ) \\
		\grAltLn \gr{P1Expr} \{ \kwd{@} | \kwd{!} \}+ \\
		\grAltLn \gr{InlineVarDecl} \\
		\grAltLn \kwd{\$} \\
	
	\grDef{P1Expr} \gr{AtomExpr} \\
		\grAltLn \gr{AtomExpr} \{ \gr{P1Op} \} \\
	
	\grDef{AtomExpr} [ \kwd{:} ] \token{Identifier} \\
		\grAltLn \gr{Literal} \\
		\grAltLn \kwd{(} \gr{Expression} \kwd{)} \\
	
	\\
	
	\grDef{AssignOpOp} \kwd{+=} | \kwd{-=} | \kwd{*=} | \kwd{/=} | \kwd{\%=} | \kwd{\&=} | \kwd{|=} | \kwd{\^{}=} | \kwd{<{}<=} \\
		\grAltLn \kwd{>{}>=} | \kwd{<{}<{}<=} | \kwd{>{}>{}>=} \\
	
	\grDef{P1Op} \gr{ParentCommaExpr} \\
		\grAltLn \kwd{[} [ \gr{RangeExpr} \{ \kwd{,} \gr{RangeExpr} ] \kwd{]} \\
		\grAltLn \kwd{.} \token{Identifier} \\
\end{grammar}

\subsection{Operator precedence}
\begin{centeredRefTabular}{P{1.5cm} | c | c | p{5cm} | c}
	\textbf{Priority} & \textbf{Operator} & \textbf{Enum} & \textbf{Semantics} & \textbf{Associativity} \\ \hline \hline
	
	1
		& \verb|x(args)| & \verb|funcCall| & Function call & Left to right \\
		& \verb|x[args]| & \verb|brackets| & Array subscripting & \\
		& \verb|x.ident| & \verb|dispatch| & Attribute access & \\
	\hline
	
	2
		& \verb|!x| & \verb|preNot| & Logical NOT & Cannot be chained \\
		& \verb|-x| & \verb|preMinus| & Sign negation & \\
		& \verb|~x| & \verb|preTilde| & Bitwise NOT & \\
		& \verb|++x| & \verb|preInc| & Prefix increment & \\
		& \verb|--x| & \verb|preDec| & Prefix decrement & \\
		\cline{2-5}
		& \verb|x++| & \verb|suffInc| & Suffix increment & Cannot be chained \\
		& \verb|x--| & \verb|suffDec| & Suffix decrement & \\
		\cline{2-5}
		& \verb|x!| & \verb|suffNot| & Mutable type & Left to right \\
		& \verb|x@| & \verb|suffAt| & Reference type & \\
		\cline{2-5}
		& \verb|$| & \verb|dollar| & Array size & \\
	\hline
	
	3
		& \verb|x * y| & \verb|binMult| & Multiplication & Left to right \\
		& \verb|x / y| & \verb|binDiv| & Division \\
		\cline{2-5}
		& \verb|x % y| & \verb|binMod| & Modulo & Cannot be chained \\
	\hline
	
	4
		& \verb|x + y| & \verb|binPlus| & Addition & Left to right \\
		& \verb|x - y| & \verb|binMinus| & Subtraction & \\
	\hline
	
	\multirow{4}{1.5cm}{\centering 5\\(cannot use P3,P4)}
		& \verb|x & y| & \verb|binAnd| & Bitwise AND & Left to right, \\
		& \verb$x | y$ & \verb|binOr| & Bitwise OR & only the same \\
		& \verb|x ^ y| & \verb|binXor| & Bitwise XOR & \\
		\cline{2-5}
		& \verb|x >> y| & \verb|binRSft| & Bitwise right shift & Cannot be chained \\
		& \verb|x << y| & \verb|binLSft| & Bitwise left shift & \\
		& \verb|x >>> y| & \verb|binRRot| & Bitwise right circular shift & \\
		& \verb|x <<< y| & \verb|binLRot| & Bitwise left circular shift & \\
	\hline
	
	6
		& \verb|x is y| & \verb|binIs| & Is (similar to equal to) & Cannot be chained \\
		& \verb|x !is y| & \verb|binIsNot| & Is not & \\
		& \verb|x in y| & \verb|binIn| & In & \\
		& \verb|x !in y| & \verb|binNotIn| & Not in & \\
		& \verb|x != y| & \verb|binNeq| & Not equal to & \\
		\cline{2-5}
		& \verb|x < y| & \verb|binLess| & Less than & Left to right, \\
		& \verb|x <= y| & \verb|binLeq| & Less than or equal to & specific chaining rules \\
		& \verb|x == y| & \verb|binEq| & Equal to & \\
		& \verb|x >= y| & \verb|binGeq| & Greater than or equal to & \\
		& \verb|x > y| & \verb|binGrt| & Less than & \\
	\hline
	
	7
		& \verb|x && y| & \verb|binLogAnd| & Logical AND & Left to right, \\
		& \verb$x || y$ & \verb|binLogOr| & Logical OR & only the same \\
	\hline
	
	8
		& \verb|x ? y : z| & \verb|tern| & Ternary conditional & Cannot be chained \\
	\hline
	
	9
		& \verb|x = y| & \verb|assign| & Assignment & Right to left, \\
		& \verb|x := y| & \verb|refAssign| & Reference assignment & only the same \\
		\cline{2-5}
		& \verb|x += y| & \verb|plusAssign| & Various assignments & Cannot be chained \\
		& \verb|x -= y| & \verb|minusAssign| && \\
		& \verb|x *= y| & \verb|multAssign| && \\
		& \verb|x /= y| & \verb|divAssign| && \\
		& \verb|x %= y| & \verb|modAssign| && \\
		& \verb|x &= y| & \verb|andAssign| && \\
		& \verb$x |= y$ & \verb|orAssign| && \\
		& \verb|x ^= y| & \verb|xorAssign| && \\
		& \verb|x <<= y| & \verb|lSftAssign| && \\
		& \verb|x >>= y| & \verb|rSftAssign| && \\
		& \verb|x <<<= y| & \verb|lRotAssign| && \\
		& \verb|x >>>= y| & \verb|rRotAssign| && \\
	\hline
		
	10 (cannot use P9)
		& \verb|x .. y| & \verb|range| & Range separator (only in array subscript args) & Cannot be chained \\
	\hline
	
	11
		& \verb|x, y| & & Comma & Left to right \\
\end{centeredRefTabular}

\paragraph{Associativity -- explanation}
\begin{compactitem}
	\item \textbf{Left to right} Operations from the same group are processed from left to right, meaning \inlineCode{x + y + z} is processed as \inlineCode{(x + y) + z}.
	\item \textbf{Right to left} Operations from the same group are processed from right to left, meaning \inlineCode{x = y = z} is processed as \inlineCode{x = (y = z)}.
	\item \textbf{Cannot be chained} Operations cannot be chained with any operator of the same priority, meaning expressions like \inlineCode{x >> y >> z}, \inlineCode{x >> y << z} or \inlineCode{++!x} are syntactically incorrect.
	\item \textbf{Only the same} Only the same operators can be chained, meaning \inlineCode{x & y & z} and \inlineCode{x | y | z} is correct, but \inlineCode{x & y | z} is not.
\end{compactitem}

\paragraph{Operator precedence specialities}
In order to improve code readability, it is prohibited to use priority 3 and 4 operations as priority 5 operands -- you must wrap them in the parentheses.
\begin{code}
x + y >> z; // Error
(x + y) >> z; // Ok
\end{code}

Also, you cannot use P9 operations as operands in the \verb|[args]| operator.

\subsection{Comparison operators chaining} Comparison operators can be chained in monotonous order:
\begin{code}
// (Almost) equivalent with (a > b) && (b >= c) && (c == d) && (d >= e) && (e > f)
a > b >= c == d >= e > f;
// (Almost) equivalent with (a <= b) && (b < c) && (c <= d) && (d == e) && (e < f)
a <= b < c <= d == e < f;
// (Almost) equivalent with (a == b) && (b == c)
a == b == c;
// Syntax error
a > b < c;
\end{code}

When chaining comparison operators, the expressions in form \inlineCode{x == y > z} are internally rewritten to \inlineCode{(x == y) && (x > z)} (supports user overloaded operators), except the \verb|x|, \verb|y| and \verb|z| expressions are evaluated only once.

\section{Operator overloading}

\begin{code}
enum Operator {
	funcCall,
	brackets,
	dispatch,
	preNot,
	// etc
	;
	
@public:
	enum : Set {
		unary = preNot | suffNot | preMinus /* etc */,
		unaryPre = preNot | preMinus | preTilde /* etc */,
		unarySuff = suffNot | suffMult | suffAnd /* etc */,
		
		binary = binMult | binDiv | binMod /* etc */,
		anyAssign = assign | refAssign | plusAssign /* etc */
	}	
}
\end{code}

All operators can be overloaded by the programmer. This is done by overloading/implementing function:
\begin{code}
auto #operator( @ctime Operator op, auto args ... );
\end{code}

So for example, you can overload all unary operators at once using:
\begin{code}
@final class UnaryProxy( Type T ) {
	
@public:
	Void #ctor( T@ value ) {
		referencedValue = value;
	}
	
@public:
	auto #operator( @ctime Operator op, auto@ args ... )
		if( op is :unary )
	{
		return referencedValue.#operator( op, args ... );
	}
	
@private:
	T! referencedValue;
	
}
\end{code}

or you can overload one exact operator:
\begin{code}
Boolean #operator( Operator.preNot ) {
	return !referencedValue;	
}
Int16 #operator( Operator("x++") ) {
	return referencedValue ++;
}
\end{code}

You can also make operator overload implementations virtual:
\begin{code}
@base class A {
	@public @abstract Void #operator( Operator.plusAssign, A@ other );
}

@final class B : @public A {
	@public @override Void #operator( Operator.plusAssign , A@ other ) {
		// code here	
	}
}
\end{code}

\paragraph{TODO} The range operator, operator parameter restrictions, overload selection

\section{Symbol lookup (identifier resolution)}
Assume following situation:
\begin{code}
module a;
import b;
	
Int8 x;

@base class C {
	
@public:
	Int8 x;
	
@public:
	@virtual Void f() {
		// Code here
	}
	Void f(Int8 arg) {
		// Code here	
	}
	
}

Void f() {
	// Code here	
}

$\moduleSep$
module b;
import a;

Int8 x;

@final class D : @public C {

@public:
	@override Void f() {
		
	}
	Void f(Int16 arg) {
	}
	
}
\end{code}

\paragraph{The '\inlineCode{:ident}' accessor}

\section{Variable declarations}
\begin{grammar}
	\grDef{InexprVarDecl} \gr{TypeExpr} \token{Identifier} [ \gr{VarDeclCtor} ] \\
	\grDef{VarDeclCmd} \gr{TypeExpr} \token{Identifier} [ \gr{VarDeclCtor} ] \\
		\grLn \{ \kwd{,} \token{Identifier} [ \gr{VarDeclCtor} ] \} \kwd{;} \\
	\\
	\grDef{TypeExpr} \{ \gr{Decoration} \} ( \gr{UnaryExpr} | \gr{AutoType} ) \\
	\grDef{AutoType} \kwd{auto} [ \kwd{@} ] [ \kwd{!} ] \\
	\grDef{VarDeclCtor} \gr{ParentCommaExpr} | \kwd{=} \gr{Expression} \\
\end{grammar}

\subsection{Inexpr variable declarations}

\chapter{Functions}
\begin{grammar}
	\grDef{FunctionDecl} \gr{TypeExpr} \token{Identifier} \gr{ParentCommaExpr} ( \gr{FunctionDefPart} | \kwd{;} ) \\
	\grDef{FunctionDefPart} [ \kwd{if} \kwd{(} \gr{Expression} \kwd{)} ] \gr{CommandBlock} \\
	\\
	\grDef{CommandBlock} \kwd{\{} \{ \gr{Command} \} \kwd{\}} \\
	\grDef{Command} \gr{VarDeclCmd} \\
		\grAltLn \gr{CommaExpression} \kwd{;} \\
\end{grammar}

\section{Variadic functions}

\section{The \kwd{auto} keyword}

\section{Parameter namespace accessor (\texttt{:ident})}

\chapter{Types}

\subsection{Pointers vs. references}
\begin{centeredRefTabular}{l | c | c}
	\textbf{Property} & \textbf{Reference} & \textbf{Pointer} \\ \hline \hline
	
	Pointer arithmetics & no & yes \\ \hline
	Can be \inlineCode{null} & yes & yes \\ \hline
	Rebindable & yes & yes \\ \hline
	Binding & \inlineCode{ref := val} & \inlineCode{ptr = \&val} \\
		& or \inlineCode{ref := \&val} & \\ \hline
	Member access & \inlineCode{ref.mem} & \inlineCode{ptr.data.mem} \\

\end{centeredRefTabular}

\chapter{Modules}
\begin{grammar}
	\grDef{ModuleEntry} \kwd{module} \gr{ModuleIdentifier} \kwd{;} \{ \gr{ModuleLvlDecl} \} \\
	\grDef{ModuleIdentifier} \token{Identifier} \{ \kwd{.} \token{Identifier} \} \\
	\\
	\grDef{ModuleLvlDecl} \gr{ModuleLvlDeclBlock} \\
		\grAltLn \gr{ImportStmt} \\
		\grAltLn \gr{FunctionDecl} \\
		\grAltLn \gr{ScopeDecorationStmt} \\
	\grDef{ScopeDecorationStmt} \{ \gr{Decoration} \}+ \kwd{:} \\
	\grDef{ModuleLvlDeclBlock} \{ \gr{Decoration} \} \kwd{\{} \gr{ModuleLvlDecl} \kwd{\}} \\
\end{grammar}

The program is divided into modules. Each module begins with a module declaration statement.
\begin{code}
module package.package.moduleName;
\end{code}

The \gr{ModuleIdentifier} in the \gr{ModuleEntry} then works as an identifier for the module. Multiple modules with the same identifier are not allowed.

\paragraph{Filesystem representation} Module identifier has to correspond with the directory structure the source file is in and the source file name has to be same as the module name (case sensitive). For example, having set up \verb|project/src| and \verb|project/include| source file directories, module \verb|straw.nati.main| has to be in file \verb|project/src/straw/nati/main.nati| or \verb|project/include/straw/nati/main.nati|.

\paragraph{Naming convention} Modules should be named in lower-CamelCase. This is not enforced, however disobeying this rule results in a warning.

\section{Imports} \label{imports}
\begin{grammar}
	\grDef{ImportStmt} \{ \gr{Decoration} \} \kwd{import} \gr{ModuleIdentifier} \kwd{;}
\end{grammar}

Using the \kwd{import} statement, you can make symbols other modules accessible for the current scope.

Imports are not modified using standard access modifier decorators (\decoratorRef{public}, \decoratorRef{private}, etc.), but with \decoratorRef{global} and \decoratorRef{local}, \decoratorRef{local} being default.

\subsection{Local imports} \label{decorator:local}
Local import makes the symbols from the specified module accessible only for the current scope (and its subscopes).

\begin{code}
module a;

Void aFunc() {
	// Do something
}

$\moduleSep$
module b;

import a; /* Equivalent with @local import a; */

Void bFunc() {
	aFunc(); // Ok
}

$\moduleSep$
module c;

import b;

Void cFunc() {
	import a;
	aFunc(); // Ok
}
Void cFunc2() {
	aFunc(); // Error	
}
\end{code}

\subsection{Global imports} \label{decorator:global}
Symbols that are imported using the global import are accessible from the current scope (and its subscopes) and all scopes that import the current scope (and their subscopes).

\begin{code}
module a;

Void aFunc() {
	// Do something
}

$\moduleSep$
module b;

@global import a;

Void bFunc() {
	aFunc(); // Ok
}

$\moduleSep$
module c;

@global import b;

Void cFunc() {
	bFunc(); // Ok
	aFunc(); // Ok	
}

$\moduleSep$
module d;

import c;

Void Func() {
	cFunc(); // Ok
	aFunc(); // Ok
}

$\moduleSep$
module e;

import d;

Void eFunc() {
	dFunc(); // Ok
	cFunc(); // Error
	aFunc(); // Error	
}
\end{code}

\chapter{Decorators}
TODO: noWarning, final, abstract, base, virtual, override, static

\begin{grammar}
	\grDef{Decoration} \kwd{@} \token{Identifier} [ \gr{ArgumentList} ]
\end{grammar}

Generally, decorators provide syntax support for altering properties of types, declarations or even blocks of code.

\section{Decorator application}
In module level, there are three ways of how to apply a decorator:
\begin{code}
module a;

@final class C {
	
// Scope decoration
@decoratorA @decoratorB:
	Int32 d;
	Int64 c;
	
	// Block decoration
	@decoratorE @decoratorF {
		Int8! b;
		Int16! c;	
	}
	
	// Statement decoration
	@decoratorC @decoratorD Int8! a;
				
}
\end{code}

\paragraph{Scope decorations} Decorators are applied to all statements following the decoration up to next scope decoration or current scope end. You can not use scope decorations directly in the module root scope.

\paragraph{Block decorations} Decorators are applied to all statements in the block.

\paragraph{Statement decorations} Decorators are applied to the statement that follows the decoration.

\subsection{Decoration contexts} \label{decorationContexts}
There are multiple different contexts in which decorators can be used. Most decorators can't be used in all the contexts.

The contexts are following:
\begin{itemize}
	\item Module level declaration
	\item Variable declaration
	\item Function declaration
	\item Parameter declaration
	\item Class declaration
	\item Enum declaration
	\item Control statement (\kwd{if}, \kwd{for}, \kwd{while}, ...)
	\item Block of code (\verb|{ /* code here */ }|)
\end{itemize}

\begin{code}
enum DecorationContext {
	importDecoration,
	moduleLevelDeclaration,
	parameterDeclaration,
	variableDeclaration,
	functionDeclaration,
	classDeclaration,
	enumDeclaration,
	typeDecoration,
	controlStatement,
	codeBlock;
	
@public:
	enum : Set {
		typeDeclaration = classDeclaration | enumDeclaration	
	}
}
\end{code} \label{enum:DecorationContext}

\subsection{Context ambiguity resolution} In some cases, the context the decorator is used in can be ambiguous. Consider following example:
\begin{code}
Void f( @ctime Int8 param ) {
	// Code here
}
\end{code}

Here, the \decoratorRef{ctime} decorator can be considered to be used in either \decorationContextRef{parameter\-Declaration}, \decorationContextRef{variable\-Decl\-aration} or \decorationContextRef{typeDecoration} context. How is it decided? The compiler tries to apply the decorator on contexts in order they are defined in the \enumRef{DecorationContext} enum, looking for a first valid match. If the decorator doesn't support any of the contexts available, an error is shown. This means that \textbf{you can't apply a decorator on a stuff the decorator doesn't support}. In some other langauges, the decorator would simply be ignored, but this does not apply for NATI.

In the example, it would first try to apply the decorator in  \decorationContextRef{parameterDeclaration} context. Because the \decoratorRef{ctime} decorator doesn't support that context, it would try the  \decorationContextRef{variableDeclaration} context, which is supported, so the resolving would succeed.

\paragraph{Decorator ordering by context} In order to improve code readability and programmer awareness, it is enforced by the compiler that decorations are ordered by the context they're used in (the order is specified in the \enumRef{DecorationContext} enum).

\subsection{Decorator conflicts}
\textbf{You can not apply two decorators that are incompatible.} The most common case are the \hyperref[accessModifierDecorators]{access modifier decorators}.
\begin{code}
@final class C {

@public:
	@private Int8 a; // Error - @public and @private decorators are incompatible
	
}
\end{code}

\section{Predefined decorators}

\subsection{Import locality modifiers (\decoratorRef{global}, \decoratorRef{local})}
The decorators only support \decorationContextRef{importDecoration} context. See \nameref{imports}.

\subsection{Access modifiers (\decoratorRef{public}, \decoratorRef{private}, \decoratorRef{protected} and \decoratorRef{friend})} \label{accessModifierDecorators}
Access modifier decorators specify where a symbol is accessible from. They only support the \decorationContextRef{moduleLevelDeclaration} context.

\paragraph{\decoratorRef{public}} \label{decorator:public} Symbols with the \decoratorRef{public} access modifier are accessible from everywhere.

\paragraph{\decoratorRef{private}} \label{decorator:private} Symbols with the \decoratorRef{private} access modifier are accessible only from the current scope.

\paragraph{\decoratorRef{protected}} \label{decorator:protected} The \decoratorRef{protected} only makes sense when used in classes. It makes symbols accessible from the current scope, its subscopes and any scope that derives from any of its subscopes.

\paragraph{\decoratorRef{friend}} \label{decorator:friend} The \decoratorRef{friend} decorator exclusively allows access to one scope symbol, specified as the parameter. This overrides the \decoratorRef{protected} or \decoratorRef{private} access restriction.

\begin{code}
@base class C {
	@private @friend( func3 ) Int8 x;
	@protected Int16 func() {
		return 32000;
	}	
	@public Int32 y;
}

@final class D : @public C {
	
@public:
	Void func2() {
		x = 6; // Error
		func(); // Ok
	}
	
}

Void func3() {
	C c;
	c.x = 5; // Ok - func3 is friend with C.x
	c.func(); // Error
	c.y = 10; // Ok
}
\end{code}

\paragraph{Inter-compatibility}
The \decoratorRef{public}, \decoratorRef{protected} and \decoratorRef{private} decorators are not compatible with any decorator from the three (this also means you can't apply them twice). Also, \decoratorRef{friend} and \decoratorRef{public} decorators are not compatible.

\subsection{The \decoratorRef{ctime} (and \decoratorRef{autoCtime}) decorator} \label{decorator:ctime}
Generally, the \decoratorRef{ctime} decorator is related with compile time execution. It supports multiple contexts and depending on the context, its semantics can slightly change.

\paragraph{Axioms overview}
\begin{itemize}
	\item A compile-time variable's value is always known at compile time (=> cannot change during runtme).
	\item A compile-time function is always evaluated in compile time. That implies that parameters must be known at compile time. The return type is also compile-time.
	\item Some runtime functions can be executed at compile time.
	\item There is a difference between a compile-time function and a function executed at compile time.
	\item A compile-time variable is implicitly castable to const runtime variable.
	\item A compile-time class can only contain compile-time fields.
	\item A compile-time class can ontain runtime functions, but those cannot modify class' fields (they can only be const).
\end{itemize}

\paragraph{Compile-time parameters}
A function parameter decorated with \decoratorRef{ctime} is a compile-time parameter. In some cases, parameters don't have to be decorated with \decoratorRef{ctime} -- class, enum and template parameters are always compile-time, so the \decoratorRef{ctime} is implicit and decorating them with it results in warning.

Compile-time parameter's values must always be known at compile time. Compile-time parameters can be mutable.

Technically, a function with compile-time parameter is a function template.

\begin{code}
// 'y' and 't' parameters are compile-time
Void f( Int32 x, @ctime Int32 y, @ctime Type t ) {
	
}
\end{code}

For more info, see \nameref{ctime:parameter}.

\paragraph{Compile-time variables}
A variable decorated with \decoratorRef{ctime} is a compile-time variable. Compile-time variables defined in function bodies \textbf{can be mutable} (global compile-time variables can not be mutable). A compile-time variable can be of a \hyperref[ctime:class]{compile-time type} (a non-compile-time variable can not be of a~compile-time type). You can not define a compile-time variable as a dynamic member of a non-compile-time class.

\begin{code}
@ctime Type! t = Int32;
t x = 5; // x is of type Int32
t = String;
t str = "asd"; // y is of type String
@ctime t str2 = "lol"; // str2 is compile-time and of type String
\end{code}

For more info, see \nameref{ctime:variable}.

\paragraph{Compile-time functions}
A function decorated with \decoratorRef{ctime} is a compile-time function. A compile-time function is always executed at compile time. It returns a \hyperref[ctime:class]{compile-time type}. Its parameters and all variables used in its body are compile-time.

The \decoratorRef{ctime} decorator should be omitted in parameter, variable and return type declaration; a warning is shown otherwise.

\begin{code}
@ctime Type TypeIntersection( Type t1, Type t2 ) {
	// if t2 is parent of t1
	if( t1 is t2 )
		return t2;
		
	// if t1 is parent of t2
	else if( t2 is t1 )
		return t1;
	
	else
		return Void;
}
\end{code}

For more info, see \nameref{ctime:function}

\paragraph{Compile-time classes}
A class decorated with \decoratorRef{ctime} is a compile-time class. Any instance of a compile-time class is a compile-time instance/variable. All its member functions are \hyperref[ctime:function]{compile-time functions}, all its member variables are \hyperref[ctime:variable]{compile-time variables} (the \decoratorRef{ctime} decorator should be omitted).

\begin{code}
@final @ctime class MyFunctionInfo {

@public:
	Void #ctor!( Function F ) {
		returnType = F.#returnType;
		parameterTypes = F.#parameters.map( x => x.type );
	}
	
@public:
	Type returnType;
	Type[] parameterTypes;	
	
}
\end{code}

For more info, see \nameref{ctime:class}.

\paragraph{Compile-time control statements}
A control statement decorated with \decoratorRef{ctime} is a compile-time control statement. In a compile-time control statement, \textbf{expressions in the statement are evaluated in compile-time, but the statement bodies are evaluated at runtime}.

All variables declared in the statement expressions are compile-time. They should be decorated with the \decoratorRef{ctime} decorator (a warning is shown otherwise).

\begin{code}
@ctime Type! t = Int8;

if( 3 == 5 )
	t = Int16; // Warning: compile-time variable modification inside a runtime control statement

// t == Int16 here

@ctime if( 4 == 5 )	
	t = Int32;
	
// t == Int16
\end{code}

\begin{code}
@ctime for( @ctime Int16 x = 0; x < 20; x ++ ) {
	// x is a compile-time variable
	writeln( "lol" );
	// The code generated from this would be twenty writeln("lol") calls
}

for( Int16 x = 0; x < 20; x ++ ) {
	// x is a runtime variable, the loop is executed at runtime	
}
\end{code}

\paragraph{Compile-time code block} A code block decorated with the \decoratorRef{ctime} is executed at compile time. All variables declared in it are compile time and they should not be decorated with the \decoratorRef{ctime} decorator.

\paragraph{The \decoratorRef{autoCtime} decorator} \label{decorator:autoCtime} This decorator works similar to the \decoratorRef{ctime}, except it only makes things compile-time when it is convenient.

In \decorationContextRef{classDeclaration} and \decorationContextRef{enumDeclaration}, it makes the type compile-time if it derives from a compile-time type or if it has a nonstatic compile-time member. For example, container types should be decorated with \decoratorRef{autoCtime} so they can store compile-time types.

In the \decorationContextRef{parameterDeclaration} context, the parameter is made compile-time whenever the function is called with a parameter value that is known at compile time.
\begin{code}
@final class HashTable( Type Key, Type Value ) {

@public:
	T!@ #operator!( Operator("x[args]"), @autoCtime Key key ) {
		Offset hash = key.#hash() % tableSize_;	
		
		// Locating the record here 
	}
	
}

Void main() {
	HashTable( String, Int32 )! table;
	
	table[ stdin.read() ] = 5;
	
	// Here the #key parameter is known at compile time, so the function is optimized (the hash calculation is performed at compile time)
	table[ "key" ] = 10;
}
\end{code}

In the \decorationContextRef{functionDeclaration} context, the function is made compile-time when all of its parameters (all of them must be decorated with \decoratorRef{autoCtime} or \decoratorRef{ctime}) and/or return type are compile time.

In the \decorationContextRef{variableDeclaration} context, the variable is made compile time if its type is compile time.

The decorator can not be used in any other contexts.

\chapter{NATI practices \& styling guide}

\begin{itemize}
	\item Class and enum names are in \verb|UpperCamelCase|.
	\item Enum members are in \verb|lowerCamelCase|. They do not contain any enum-related prefixes.
	\item Decorator names are in \verb|lowerCamelCase|.
	\item Variable (and parameter) names are in \verb|lowerCamelCase|, type variables are in \verb|UpperCamelCase|.
	\item Function names are in \verb|lowerCamelCase|.
	\item The \verb|_| symbol can be used in identifiers as a separator (for example class \verb|PizzaIngredient_Cheese|).
\end{itemize}

\section{Further recommended code style}
\begin{itemize}
	\item Indent with tabs (so anyone can set up tab size based on his preferences)
	\item Spaces in statements like this: \inlineCode{if( expr ) \{}, opening brace on the same line
	\item Spaces around operators: \inlineCode{x + y}
	\item Decorators on the same line with decorated symbols.
\end{itemize}

\chapter{Plans for the future}
\begin{itemize}
	\item Aliased imports
	\item Namespaces
	\item User decorators
	\item Blueprints -- "mixin classes" -- bad idea?
	\item Mixins
	\item Mixins but no mixins (not mixing a string, mixing a declaration)
	\item Lambdas
	\item Singletons
	\item Extern functions -- cooperation with other programming languages
	\item Compiler support for documentation comments?
	\item Compiler outputs intellisense data?
	\item Compiler caching
\end{itemize}

\section{Documentation to-do}
\begin{itemize}
	\item Virtual functions, when a class is virtual
	\item Overloading rules, identifier resolution rules -- single resolution possible rule? (exception for same modules)
	\item \decoratorRef{noWarning(W103)}
	\item \decoratorRef{label} (for break, continue nested)
	\item \decoratorRef{notNull}
	\item \verb|#| prefixed identifiers (rules, restrictions) + \verb|to|
	\item \inlineCode{class X : @public @final Y}
\end{itemize}

\section{Random thoughts scrapbook}
\begin{code}
auto max( auto x, x.#type y ) = ( x > y ) ? x : y;

T!@ #new( @ctime Type T ) {
	return malloc( T.#size ).to( T!@ );
}

decorator.ctime or decorator( ctime )
module.straw.nati.test or module( straw.nati.test )

class null {
	@public @static	T #implicitCast( Type T )
		if( T is Pointer )
	{
		module.this
		module.straw.nati.functionInAnotherModule();
		module( "asd.test" ).functionInAnotherModule();
		return T(0);
	}
}
\end{code}

\end{document}          
